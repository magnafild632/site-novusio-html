#!/bin/bash

# =============================================================================
# NOVUSIO - SCRIPT DE DEPLOY AUTOM√ÅTICO PARA VPS
# =============================================================================
# Este script instala e configura automaticamente o sistema Novusio em um VPS
# Inclui: Nginx, PM2, SSL, Firewall, Backup e Monitoramento
# =============================================================================

set -e  # Parar em caso de erro

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Fun√ß√£o para logging
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
    exit 1
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Banner
show_banner() {
    clear
    echo -e "${PURPLE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                                                              ‚ïë"
    echo "‚ïë              üöÄ NOVUSIO DEPLOY AUTOM√ÅTICO üöÄ                ‚ïë"
    echo "‚ïë                                                              ‚ïë"
    echo "‚ïë              Deploy completo para VPS Ubuntu/Debian          ‚ïë"
    echo "‚ïë                                                              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

# Menu principal
show_menu() {
    echo -e "${CYAN}üìã MENU PRINCIPAL - NOVUSIO${NC}"
    echo "=================================="
    echo "1. üöÄ Deploy Completo (Nova Instala√ß√£o)"
    echo "2. üîÑ Atualizar Aplica√ß√£o"
    echo "3. üóëÔ∏è  Remover Projeto Completamente"
    echo "4. üìä Status do Sistema"
    echo "5. üîß Manuten√ß√£o R√°pida"
    echo "6. üìù Logs e Monitoramento"
    echo "7. üîç Diagn√≥stico Nginx (Upload 413)"
    echo "8. üõ†Ô∏è  Corrigir Problemas de Upload"
    echo "9. ‚ùå Sair"
    echo "10. ‚ö° Atualiza√ß√£o R√°pida (n√£o interativa)"
    echo ""
    read -p "Escolha uma op√ß√£o [1-10]: " MENU_CHOICE
}

# Atualiza√ß√£o r√°pida (n√£o interativa)
quick_update() {
    echo -e "${CYAN}‚ö° ATUALIZA√á√ÉO R√ÅPIDA${NC}"
    echo "=================================="
    
    if [[ ! -d "/home/novusio" ]]; then
        error "‚ùå Projeto n√£o encontrado em /home/novusio"
    fi
    
    log "üì• Atualizando c√≥digo..."
    cd /home/novusio
    sudo -u novusio git pull --rebase || git pull
    
    log "üì¶ Instalando depend√™ncias (server)..."
    npm ci --production || npm install --production
    
    if [[ -d "client" ]]; then
        log "üì¶ Instalando depend√™ncias (client) e build..."
        cd client
        npm ci || npm install
        npm run build
        cd ..
    fi
    
    # Atualizar configura√ß√£o do Nginx
    log "üåê Atualizando configura√ß√£o do Nginx..."
    if [[ -f "instalador/nginx.conf" ]]; then
        cp "instalador/nginx.conf" "/etc/nginx/sites-available/novusiopy"
        # Recarregar nginx para aplicar mudan√ßas
        if nginx -t 2>/dev/null; then
            systemctl reload nginx
            sleep 2
            systemctl restart nginx
            log "‚úì Configura√ß√£o do Nginx atualizada e reiniciada com limites de upload corrigidos (50MB)"
        else
            warning "‚ö†Ô∏è Erro na configura√ß√£o do Nginx, mas continuando..."
        fi
    fi
    
    # Garantir permiss√µes corretas para uploads
    log "üìÅ Verificando permiss√µes de uploads..."
    if [[ -d "/home/novusio/uploads" ]]; then
        chown -R novusio:novusio "/home/novusio/uploads"
        find "/home/novusio/uploads" -type d -exec chmod 755 {} + 2>/dev/null || true
        find "/home/novusio/uploads" -type f -exec chmod 644 {} + 2>/dev/null || true
        # Garantir que o diret√≥rio pai tamb√©m tenha permiss√µes corretas
        chmod 755 /home/novusio
        systemctl reload nginx 2>/dev/null || true
    fi
    
    log "üîÑ Reiniciando aplica√ß√£o (PM2)..."
    sudo -u novusio pm2 start ecosystem.config.js --env production || true
    sudo -u novusio pm2 reload novusio-server || sudo -u novusio pm2 restart novusio-server || true
    sudo -u novusio pm2 save
    
    log "‚úÖ Atualiza√ß√£o r√°pida conclu√≠da!"
}

# Deploy completo (fun√ß√£o existente)
deploy_complete() {
    log "üöÄ Iniciando deploy completo..."
    
    echo ""
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${GREEN}           DEPLOY COMPLETO - PASSO A PASSO${NC}"
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    
    echo -e "${CYAN}[1/15]${NC} Coletando informa√ß√µes..."
    collect_info
    
    echo -e "${CYAN}[2/15]${NC} Verificando DNS..."
    check_dns
    
    echo -e "${CYAN}[3/15]${NC} Atualizando sistema..."
    update_system
    
    echo -e "${CYAN}[4/15]${NC} Instalando pacotes..."
    install_packages
    
    echo -e "${CYAN}[5/15]${NC} Configurando firewall..."
    setup_firewall
    
    echo -e "${CYAN}[6/15]${NC} Criando usu√°rio..."
    create_user
    
    echo -e "${CYAN}[7/15]${NC} Clonando reposit√≥rio..."
    clone_repository
    
    echo -e "${CYAN}[8/15]${NC} Fazendo build da aplica√ß√£o..."
    build_application
    
    echo -e "${CYAN}[9/15]${NC} Configurando vari√°veis de ambiente..."
    setup_environment
    
    echo -e "${CYAN}[10/15]${NC} Configurando PM2..."
    setup_pm2
    
    echo ""
    echo -e "${YELLOW}‚è© Continuando com configura√ß√£o do servidor web...${NC}"
    sleep 1
    
    echo ""
    echo -e "${CYAN}[11/15]${NC} Configurando Nginx..."
    setup_nginx
    
    echo ""
    echo -e "${YELLOW}‚è© Pr√≥ximo: Configura√ß√£o SSL...${NC}"
    sleep 1
    
    echo ""
    echo -e "${CYAN}[12/15]${NC} Configurando SSL/HTTPS..."
    setup_ssl
    
    echo -e "${CYAN}[13/15]${NC} Configurando backup autom√°tico..."
    setup_backup
    
    echo -e "${CYAN}[14/15]${NC} Configurando monitoramento..."
    setup_monitoring
    
    setup_logrotate
    
    echo -e "${CYAN}[15/15]${NC} Inicializando banco de dados..."
    init_database
    
    restart_services
    verify_installation
    
    # Verifica√ß√£o final do SSL
    echo ""
    echo -e "${BLUE}üîç Verifica√ß√£o Final do SSL...${NC}"
    if [[ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]]; then
        echo -e "${GREEN}‚úÖ Certificado SSL instalado e funcionando!${NC}"
        echo "  ‚Ä¢ Certificado: /etc/letsencrypt/live/$DOMAIN/"
        
        # Mostrar data de expira√ß√£o
        EXPIRY=$(openssl x509 -enddate -noout -in "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" 2>/dev/null | cut -d= -f2)
        if [[ -n "$EXPIRY" ]]; then
            echo "  ‚Ä¢ Expira em: $EXPIRY"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è Certificado SSL N√ÉO foi instalado!${NC}"
        echo ""
        echo "Para configurar SSL agora, execute:"
        echo "  sudo certbot --nginx -d $DOMAIN -d www.$DOMAIN --email $EMAIL --redirect"
        echo ""
    fi
    
    show_final_info
}

# Atualizar aplica√ß√£o
update_application() {
    echo -e "${CYAN}üîÑ ATUALIZA√á√ÉO DA APLICA√á√ÉO${NC}"
    echo "=================================="
    
    # Verificar se o projeto existe
    if [[ ! -d "/home/novusio" ]]; then
        error "‚ùå Projeto n√£o encontrado em /home/novusio"
    fi
    
    log "üîÑ Iniciando atualiza√ß√£o da aplica√ß√£o..."
    
    cd /home/novusio
    
    # Backup antes da atualiza√ß√£o
    log "üíæ Criando backup antes da atualiza√ß√£o..."
    /usr/local/bin/novusio-backup.sh 2>/dev/null || true
    
    # Parar aplica√ß√£o
    log "‚èπÔ∏è Parando aplica√ß√£o..."
    sudo -u novusio pm2 stop novusio-server || true
    
    # Atualizar c√≥digo
    log "üì• Atualizando c√≥digo do reposit√≥rio..."
    sudo -u novusio git config --global --add safe.directory /home/novusio || true
    sudo -u novusio git pull origin main || sudo -u novusio git pull origin master
    
    # Instalar depend√™ncias
    log "üì¶ Instalando depend√™ncias..."
    npm ci --production
    
    if [[ -d "client" ]]; then
        log "üì¶ Instalando depend√™ncias do cliente..."
        cd client
        npm ci
        npm run build
        cd ..
    fi
    
    # Atualizar configura√ß√£o do Nginx
    log "üåê Atualizando configura√ß√£o do Nginx..."
    if [[ -f "instalador/nginx.conf" ]]; then
        cp "instalador/nginx.conf" "/etc/nginx/sites-available/novusiopy"
        # Recarregar nginx para aplicar mudan√ßas
        if nginx -t 2>/dev/null; then
            systemctl reload nginx
            sleep 2
            systemctl restart nginx
            log "‚úì Configura√ß√£o do Nginx atualizada e reiniciada com limites de upload corrigidos (50MB)"
        else
            warning "‚ö†Ô∏è Erro na configura√ß√£o do Nginx, mas continuando..."
        fi
    fi
    
    # Verificar configura√ß√µes
    if [[ ! -f ".env" ]]; then
        warning "‚ö†Ô∏è Arquivo .env n√£o encontrado, gerando novo..."
        
        # Gerar secrets seguros
        JWT_SECRET=$(openssl rand -base64 48 | tr -d '\n')
        SESSION_SECRET=$(openssl rand -base64 32 | tr -d '\n')
        
        log "‚úì JWT Secret gerado: ${JWT_SECRET:0:10}..."
        log "‚úì Session Secret gerado: ${SESSION_SECRET:0:10}..."
        
        # Detectar dom√≠nio da configura√ß√£o Nginx
        DOMAIN=$(grep -h "server_name" /etc/nginx/sites-available/* 2>/dev/null | grep -v "www" | awk '{print $2}' | sed 's/;//' | head -1)
        [[ -z "$DOMAIN" ]] && DOMAIN="localhost"
        
        # Criar arquivo .env
        cat > .env << EOF
# Configura√ß√µes geradas durante atualiza√ß√£o
NODE_ENV=production
PORT=3000
JWT_SECRET=$JWT_SECRET
SESSION_SECRET=$SESSION_SECRET
DB_PATH=/home/novusio/database.sqlite
UPLOAD_PATH=/home/novusio/uploads
DOMAIN=$DOMAIN
BASE_URL=https://$DOMAIN
EOF
        
        chown novusio:novusio .env
        chmod 600 .env
        
        log "‚úì Arquivo .env criado com secrets seguros"
        warning "‚ö†Ô∏è Revise e configure o arquivo .env conforme necess√°rio!"
    fi
    
    # Garantir permiss√µes corretas para uploads
    log "üìÅ Verificando permiss√µes de uploads..."
    if [[ -d "/home/novusio/uploads" ]]; then
        chown -R novusio:novusio "/home/novusio/uploads"
        find "/home/novusio/uploads" -type d -exec chmod 755 {} + 2>/dev/null || true
        find "/home/novusio/uploads" -type f -exec chmod 644 {} + 2>/dev/null || true
        # Garantir que o diret√≥rio pai tamb√©m tenha permiss√µes corretas
        chmod 755 /home/novusio
        systemctl reload nginx 2>/dev/null || true
    fi
    
    # Reiniciar aplica√ß√£o
    log "üîÑ Reiniciando aplica√ß√£o..."
    sudo -u novusio pm2 start ecosystem.config.js || true
    sudo -u novusio pm2 reload novusio-server || sudo -u novusio pm2 restart novusio-server || true
    sudo -u novusio pm2 save
    
    # Verificar status
    log "‚úÖ Verificando status da aplica√ß√£o..."
    sleep 5
    
    if sudo -u novusio pm2 list | grep -Eiq "novusio-server\s+.*online"; then
        log "‚úÖ Aplica√ß√£o atualizada e rodando com sucesso!"
    else
        error "‚ùå Falha ao iniciar a aplica√ß√£o ap√≥s atualiza√ß√£o"
    fi
    
    echo -e "${GREEN}üéâ Atualiza√ß√£o conclu√≠da com sucesso!${NC}"
}

# Remover projeto completamente
remove_project() {
    echo -e "${RED}üóëÔ∏è REMO√á√ÉO COMPLETA DO PROJETO${NC}"
    echo "=================================="
    echo -e "${YELLOW}‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° remover completamente o projeto Novusio!${NC}"
    echo -e "${YELLOW}   Isso inclui:${NC}"
    echo -e "${YELLOW}   - Aplica√ß√£o e c√≥digo fonte${NC}"
    echo -e "${YELLOW}   - Banco de dados${NC}"
    echo -e "${YELLOW}   - Arquivos de upload${NC}"
    echo -e "${YELLOW}   - Configura√ß√µes${NC}"
    echo -e "${YELLOW}   - Logs${NC}"
    echo ""
    read -p "Tem certeza que deseja continuar? Digite 'CONFIRMAR' para prosseguir: " CONFIRMATION
    
    if [[ "$CONFIRMATION" != "CONFIRMAR" ]]; then
        echo -e "${GREEN}‚úÖ Opera√ß√£o cancelada${NC}"
        return
    fi
    
    log "üóëÔ∏è Iniciando remo√ß√£o completa do projeto..."
    
    # Parar aplica√ß√£o
    log "‚èπÔ∏è Parando aplica√ß√£o..."
    sudo -u novusio pm2 stop novusio-server 2>/dev/null || true
    sudo -u novusio pm2 delete novusio-server 2>/dev/null || true
    
    # Remover PM2 do startup
    sudo -u novusio pm2 unstartup systemd 2>/dev/null || true
    
    # Remover configura√ß√µes do Nginx - usar vari√°vel de dom√≠nio se dispon√≠vel
    log "üåê Removendo configura√ß√µes do Nginx..."
    
    # Tentar encontrar a configura√ß√£o do Novusio
    NGINX_CONFIG=$(find /etc/nginx/sites-available/ -name "*.conf" -o -name "novusio*" 2>/dev/null | head -1)
    if [[ -z "$NGINX_CONFIG" ]]; then
        # Buscar por configura√ß√µes que contenham "novusio" no conte√∫do
        NGINX_CONFIG=$(grep -l "novusio" /etc/nginx/sites-available/* 2>/dev/null | head -1)
    fi
    
    if [[ -n "$NGINX_CONFIG" ]]; then
        NGINX_FILENAME=$(basename "$NGINX_CONFIG")
        rm -f "/etc/nginx/sites-enabled/$NGINX_FILENAME"
        rm -f "/etc/nginx/sites-available/$NGINX_FILENAME"
        log "‚úì Configura√ß√£o Nginx removida: $NGINX_FILENAME"
    else
        warning "‚ö†Ô∏è Configura√ß√£o Nginx do Novusio n√£o encontrada"
    fi
    
    # Testar e recarregar Nginx
    if nginx -t 2>/dev/null; then
        systemctl reload nginx
    else
        warning "‚ö†Ô∏è Erro ao recarregar Nginx, mas continuando remo√ß√£o..."
    fi
    
    # Remover certificados SSL (opcional)
    read -p "Deseja remover os certificados SSL? (y/N): " REMOVE_SSL
    if [[ "$REMOVE_SSL" =~ ^[Yy]$ ]]; then
        log "üîí Removendo certificados SSL..."
        certbot delete --cert-name $(cat /etc/nginx/sites-available/novusio 2>/dev/null | grep server_name | head -1 | awk '{print $2}' | sed 's/;//') --non-interactive 2>/dev/null || true
    fi
    
    # Remover diret√≥rios e arquivos
    log "üóëÔ∏è Removendo arquivos do projeto..."
    rm -rf /home/novusio
    rm -rf /var/log/novusio
    rm -rf /opt/backups/novusio
    
    # Remover scripts de sistema
    log "üîß Removendo scripts de sistema..."
    rm -f /usr/local/bin/novusio-backup.sh
    rm -f /usr/local/bin/novusio-monitor.sh
    rm -f /etc/systemd/system/novusio.service
    
    # Remover usu√°rio (opcional)
    read -p "Deseja remover o usu√°rio 'novusio'? (y/N): " REMOVE_USER
    if [[ "$REMOVE_USER" =~ ^[Yy]$ ]]; then
        log "üë§ Removendo usu√°rio novusio..."
        userdel -r novusio 2>/dev/null || true
    fi
    
    # Remover crontabs
    log "‚è∞ Removendo tarefas agendadas..."
    crontab -l 2>/dev/null | grep -v novusio | crontab - 2>/dev/null || true
    
    # Remover configura√ß√µes do Fail2ban
    log "üõ°Ô∏è Removendo configura√ß√µes do Fail2ban..."
    rm -f /etc/fail2ban/jail.d/novusio.conf
    rm -f /etc/fail2ban/filter.d/novusio-*.conf
    systemctl reload fail2ban 2>/dev/null || true
    
    log "‚úÖ Projeto removido completamente!"
    echo -e "${GREEN}üéâ Remo√ß√£o conclu√≠da com sucesso!${NC}"
}

# Status do sistema
show_system_status() {
    echo -e "${CYAN}üìä STATUS DO SISTEMA${NC}"
    echo "=================================="
    
    # Status da aplica√ß√£o
    echo -e "${BLUE}üîÑ Status da Aplica√ß√£o:${NC}"
    if pm2 list | grep -q "novusio-server.*online"; then
        echo -e "  ${GREEN}‚úÖ Aplica√ß√£o rodando${NC}"
        pm2 list | grep novusio-server
    else
        echo -e "  ${RED}‚ùå Aplica√ß√£o n√£o est√° rodando${NC}"
    fi
    
    echo ""
    
    # Status dos servi√ßos
    echo -e "${BLUE}üåê Status dos Servi√ßos:${NC}"
    services=("nginx" "fail2ban")
    for service in "${services[@]}"; do
        if systemctl is-active --quiet "$service"; then
            echo -e "  ${GREEN}‚úÖ $service ativo${NC}"
        else
            echo -e "  ${RED}‚ùå $service inativo${NC}"
        fi
    done
    
    echo ""
    
    # Recursos do sistema
    echo -e "${BLUE}üíª Recursos do Sistema:${NC}"
    echo "  Mem√≥ria: $(free -h | awk 'NR==2{printf "%.1f%%", $3*100/$2}')"
    echo "  Disco: $(df -h / | awk 'NR==2{print $5}') usado"
    echo "  CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')%"
    
    echo ""
    
    # SSL
    echo -e "${BLUE}üîí Certificado SSL:${NC}"
    if [[ -f "/etc/letsencrypt/live/*/fullchain.pem" ]]; then
        DOMAIN=$(ls /etc/letsencrypt/live/ | head -1)
        EXPIRY=$(openssl x509 -enddate -noout -in "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" 2>/dev/null | cut -d= -f2)
        if [[ -n "$EXPIRY" ]]; then
            echo -e "  ${GREEN}‚úÖ Certificado v√°lido at√©: $EXPIRY${NC}"
        else
            echo -e "  ${YELLOW}‚ö†Ô∏è Certificado encontrado mas n√£o foi poss√≠vel verificar expira√ß√£o${NC}"
        fi
    else
        echo -e "  ${RED}‚ùå Certificado SSL n√£o encontrado${NC}"
    fi
    
    echo ""
    
    # √öltimo backup
    echo -e "${BLUE}üíæ √öltimo Backup:${NC}"
    if [[ -d "/opt/backups/novusio" ]]; then
        LAST_BACKUP=$(find /opt/backups/novusio -name "*.sqlite" -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2-)
        if [[ -n "$LAST_BACKUP" ]]; then
            BACKUP_DATE=$(stat -c %y "$LAST_BACKUP" 2>/dev/null || stat -f %Sm "$LAST_BACKUP" 2>/dev/null)
            echo -e "  ${GREEN}‚úÖ $BACKUP_DATE${NC}"
        else
            echo -e "  ${YELLOW}‚ö†Ô∏è Nenhum backup encontrado${NC}"
        fi
    else
        echo -e "  ${RED}‚ùå Diret√≥rio de backup n√£o existe${NC}"
    fi
}

# Manuten√ß√£o r√°pida
quick_maintenance() {
    echo -e "${CYAN}üîß MANUTEN√á√ÉO R√ÅPIDA${NC}"
    echo "=================================="
    
    log "üîß Iniciando manuten√ß√£o r√°pida..."
    
    # Reiniciar aplica√ß√£o
    log "üîÑ Reiniciando aplica√ß√£o..."
    cd /home/novusio
    sudo -u novusio pm2 restart novusio-server
    
    # Recarregar Nginx
    log "üåê Recarregando Nginx..."
    systemctl reload nginx
    
    # Limpar logs antigos
    log "üßπ Limpando logs antigos..."
    find /var/log/novusio -name "*.log" -mtime +30 -delete 2>/dev/null || true
    find /var/log/nginx -name "*.log.*" -mtime +30 -delete 2>/dev/null || true
    
    # Limpar cache do sistema
    log "üßπ Limpando cache do sistema..."
    apt-get autoremove -y 2>/dev/null || true
    apt-get autoclean 2>/dev/null || true
    
    # Verificar e corrigir permiss√µes
    log "üîê Verificando permiss√µes..."
    if [[ -d "/home/novusio" ]]; then
        chown -R novusio:novusio /home/novusio
        chmod 600 /home/novusio/.env 2>/dev/null || true
    fi
    
    log "‚úÖ Manuten√ß√£o r√°pida conclu√≠da!"
}

# Logs e monitoramento
show_logs() {
    echo -e "${CYAN}üìù LOGS E MONITORAMENTO${NC}"
    echo "=================================="
    echo "1. üìã Logs da Aplica√ß√£o (PM2)"
    echo "2. üåê Logs do Nginx"
    echo "3. üõ°Ô∏è Logs do Fail2ban"
    echo "4. üíæ Logs de Backup"
    echo "5. üìä Logs de Monitoramento"
    echo "6. üîç Logs do Sistema"
    echo "7. ‚¨ÖÔ∏è Voltar"
    echo ""
    read -p "Escolha uma op√ß√£o [1-7]: " LOG_CHOICE
    
    case $LOG_CHOICE in
        1)
            echo -e "${BLUE}üìã Logs da Aplica√ß√£o (√∫ltimas 50 linhas):${NC}"
            sudo -u novusio pm2 logs --lines 50
            ;;
        2)
            echo -e "${BLUE}üåê Logs do Nginx (√∫ltimas 50 linhas):${NC}"
            tail -50 /var/log/nginx/access.log
            echo ""
            echo -e "${BLUE}üåê Logs de Erro do Nginx (√∫ltimas 20 linhas):${NC}"
            tail -20 /var/log/nginx/error.log
            ;;
        3)
            echo -e "${BLUE}üõ°Ô∏è Status do Fail2ban:${NC}"
            fail2ban-client status
            ;;
        4)
            echo -e "${BLUE}üíæ Logs de Backup (√∫ltimas 20 linhas):${NC}"
            tail -20 /var/log/novusio-backup.log 2>/dev/null || echo "Nenhum log de backup encontrado"
            ;;
        5)
            echo -e "${BLUE}üìä Logs de Monitoramento (√∫ltimas 20 linhas):${NC}"
            tail -20 /var/log/novusio-monitor.log 2>/dev/null || echo "Nenhum log de monitoramento encontrado"
            ;;
        6)
            echo -e "${BLUE}üîç Logs do Sistema (√∫ltimas 30 linhas):${NC}"
            journalctl -u nginx -u fail2ban --lines 30 --no-pager
            ;;
        7)
            return
            ;;
        *)
            echo -e "${RED}‚ùå Op√ß√£o inv√°lida${NC}"
            ;;
    esac
    
    echo ""
    read -p "Pressione Enter para continuar..."
}

# Diagn√≥stico Nginx
diagnose_nginx() {
    echo -e "${CYAN}üîç DIAGN√ìSTICO NGINX${NC}"
    echo "=================================="
    echo "Este diagn√≥stico ir√° verificar:"
    echo "  ‚úÖ Status do Nginx"
    echo "  ‚úÖ Configura√ß√µes de upload"
    echo "  ‚úÖ Limites de client_max_body_size"
    echo "  ‚úÖ Logs de erro"
    echo "  ‚úÖ Conectividade"
    echo ""
    read -p "Iniciar diagn√≥stico? (Y/n): " START_DIAGNOSIS
    
    if [[ "$START_DIAGNOSIS" =~ ^[Nn]$ ]]; then
        echo -e "${YELLOW}‚ùå Diagn√≥stico cancelado${NC}"
        return
    fi
    
    # Executar script de diagn√≥stico se existir
    if [[ -f "instalador/diagnosticar-nginx.sh" ]]; then
        log "üîç Executando diagn√≥stico do Nginx..."
        bash "instalador/diagnosticar-nginx.sh"
    else
        echo -e "${RED}‚ùå Script de diagn√≥stico n√£o encontrado${NC}"
        echo "Execute manualmente: sudo ./instalador/diagnosticar-nginx.sh"
    fi
}

# Corrigir problemas de upload
fix_upload_issues() {
    echo -e "${CYAN}üõ†Ô∏è CORRIGIR PROBLEMAS DE UPLOAD${NC}"
    echo "=================================="
    echo "Este script ir√° corrigir:"
    echo "  ‚úÖ Erro 413 (Request Entity Too Large)"
    echo "  ‚úÖ Limites de upload para 50MB"
    echo "  ‚úÖ Configura√ß√£o do Nginx"
    echo "  ‚úÖ Configura√ß√£o do servidor Node.js"
    echo ""
    read -p "Aplicar corre√ß√µes? (Y/n): " APPLY_FIXES
    
    if [[ "$APPLY_FIXES" =~ ^[Nn]$ ]]; then
        echo -e "${YELLOW}‚ùå Corre√ß√µes canceladas${NC}"
        return
    fi
    
    # Executar script de corre√ß√£o se existir
    if [[ -f "instalador/corrigir-upload.sh" ]]; then
        log "üõ†Ô∏è Aplicando corre√ß√µes de upload..."
        bash "instalador/corrigir-upload.sh"
    else
        echo -e "${RED}‚ùå Script de corre√ß√£o n√£o encontrado${NC}"
        echo "Execute manualmente: sudo ./instalador/corrigir-upload.sh"
    fi
}

# Verificar se est√° rodando como root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "Este script deve ser executado como root. Use: sudo $0"
    fi
    log "‚úì Executando como root"
}

# Coletar informa√ß√µes do usu√°rio
collect_info() {
    echo -e "${CYAN}üìã CONFIGURA√á√ÉO INICIAL${NC}"
    echo "=================================="
    
    # Informa√ß√µes do sistema
    read -p "üåê Dom√≠nio (ex: novusio.com): " DOMAIN
    # Fixos conforme solicitado
    EMAIL="suporte@novusiopy.com"
    APP_PORT=3000
    PROJECT_DIR="/home/novusio"
    read -p "üë§ Usu√°rio do sistema (ex: novusio): " USERNAME
    read -p "üîó Reposit√≥rio Git: " GIT_REPO
    
    # Valida√ß√µes b√°sicas
    if [[ -z "$DOMAIN" || -z "$EMAIL" || -z "$USERNAME" || -z "$GIT_REPO" ]]; then
        error "Todos os campos obrigat√≥rios devem ser preenchidos!"
    fi
    
    # Validar formato do email
    if [[ ! "$EMAIL" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]; then
        error "Email inv√°lido!"
    fi
    
    # Validar formato do dom√≠nio
    if [[ ! "$DOMAIN" =~ ^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?\.[a-zA-Z]{2,}$ ]]; then
        error "Dom√≠nio inv√°lido!"
    fi
    
    # Verificar se o diret√≥rio j√° existe e n√£o √© vazio
    if [[ -d "$PROJECT_DIR" ]] && [[ "$(ls -A $PROJECT_DIR)" ]]; then
        warning "‚ö†Ô∏è O diret√≥rio $PROJECT_DIR j√° existe e n√£o est√° vazio!"
        read -p "Deseja continuar mesmo assim? (y/N): " CONTINUE_DIR
        if [[ ! "$CONTINUE_DIR" =~ ^[Yy]$ ]]; then
            error "Deploy cancelado. Escolha um diret√≥rio diferente."
        fi
    fi
    
    # Verificar se a porta j√° est√° em uso
    if netstat -tuln 2>/dev/null | grep -q ":$APP_PORT " || ss -tuln 2>/dev/null | grep -q ":$APP_PORT "; then
        warning "‚ö†Ô∏è A porta $APP_PORT j√° est√° em uso por outro processo!"
        read -p "Deseja continuar mesmo assim? (y/N): " CONTINUE_PORT
        if [[ ! "$CONTINUE_PORT" =~ ^[Yy]$ ]]; then
            error "Deploy cancelado. Escolha uma porta diferente."
        fi
    fi
    
    # Verificar se o usu√°rio j√° existe
    if id "$USERNAME" &>/dev/null; then
        warning "‚ö†Ô∏è O usu√°rio $USERNAME j√° existe no sistema!"
        read -p "Deseja usar este usu√°rio existente? (Y/n): " USE_EXISTING_USER
        if [[ "$USE_EXISTING_USER" =~ ^[Nn]$ ]]; then
            error "Deploy cancelado. Escolha um usu√°rio diferente."
        fi
    fi
    
    # Verificar se j√° existe configura√ß√£o Nginx para este dom√≠nio
    if [[ -f "/etc/nginx/sites-available/$DOMAIN" ]] || [[ -f "/etc/nginx/sites-enabled/$DOMAIN" ]]; then
        warning "‚ö†Ô∏è J√° existe configura√ß√£o Nginx para o dom√≠nio $DOMAIN!"
        read -p "Deseja sobrescrever? (y/N): " OVERWRITE_NGINX
        if [[ ! "$OVERWRITE_NGINX" =~ ^[Yy]$ ]]; then
            error "Deploy cancelado. O dom√≠nio j√° est√° configurado."
        fi
    fi
    
    log "‚úì Informa√ß√µes coletadas e validadas com sucesso"
}

# Verificar DNS
check_dns() {
    log "üîç Verificando DNS do dom√≠nio $DOMAIN..."
    
    # Verificar se o dom√≠nio aponta para este servidor
    SERVER_IP=$(curl -s ifconfig.me)
    DOMAIN_IP=$(dig +short $DOMAIN | tail -n1)
    
    if [[ "$DOMAIN_IP" != "$SERVER_IP" ]]; then
        warning "‚ö†Ô∏è  ATEN√á√ÉO: O dom√≠nio $DOMAIN ($DOMAIN_IP) n√£o aponta para este servidor ($SERVER_IP)"
        warning "   Certifique-se de que o DNS est√° configurado corretamente antes de continuar"
        read -p "   Deseja continuar mesmo assim? (y/N): " CONTINUE_DNS
        if [[ ! "$CONTINUE_DNS" =~ ^[Yy]$ ]]; then
            error "Deploy cancelado. Configure o DNS primeiro."
        fi
    else
        log "‚úì DNS configurado corretamente"
    fi
}

# Atualizar sistema
update_system() {
    log "üîÑ Atualizando sistema..."
    apt-get update -y
    apt-get upgrade -y
    log "‚úì Sistema atualizado"
}

# Instalar pacotes essenciais
install_packages() {
    log "üì¶ Instalando pacotes essenciais..."
    
    # Pacotes b√°sicos
    apt-get install -y \
        curl \
        git \
        nginx \
        ufw \
        snapd \
        software-properties-common \
        apt-transport-https \
        ca-certificates \
        gnupg \
        lsb-release \
        unzip \
        htop \
        nano \
        vim \
        wget \
        jq \
        fail2ban
    
    # Instalar Node.js 18.x
    log "üì¶ Instalando Node.js 18.x..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    apt-get install -y nodejs
    
    # Instalar PM2 globalmente
    npm install -g pm2
    
    log "‚úì Pacotes instalados com sucesso"
}

# Configurar firewall
setup_firewall() {
    log "üî• Configurando firewall (UFW)..."
    
    # Verificar se UFW j√° est√° ativo
    if ufw status | grep -q "Status: active"; then
        warning "‚ö†Ô∏è Firewall UFW j√° est√° ativo. Adicionando apenas regras necess√°rias..."
        
        # N√£o resetar - apenas adicionar regras
        ufw allow ssh 2>/dev/null || true
        ufw allow 22/tcp 2>/dev/null || true
        ufw allow 80/tcp 2>/dev/null || true
        ufw allow 443/tcp 2>/dev/null || true
        
        if [[ "$APP_PORT" != "80" && "$APP_PORT" != "443" ]]; then
            ufw allow $APP_PORT/tcp 2>/dev/null || true
        fi
    else
        # Configura√ß√£o inicial do firewall
        log "üî• Configurando firewall pela primeira vez..."
        
        # Pol√≠ticas padr√£o
        ufw default deny incoming
        ufw default allow outgoing
        
        # Permitir SSH
        ufw allow ssh
        ufw allow 22/tcp
        
        # Permitir HTTP e HTTPS
        ufw allow 80/tcp
        ufw allow 443/tcp
        
        # Permitir porta da aplica√ß√£o (se diferente de 80/443)
        if [[ "$APP_PORT" != "80" && "$APP_PORT" != "443" ]]; then
            ufw allow $APP_PORT/tcp
        fi
        
        # Habilitar firewall
        ufw --force enable
    fi
    
    log "‚úì Firewall configurado"
}

# Criar usu√°rio do sistema
create_user() {
    log "üë§ Criando usu√°rio $USERNAME..."
    
    # Verificar se usu√°rio j√° existe
    if id "$USERNAME" &>/dev/null; then
        warning "Usu√°rio $USERNAME j√° existe"
    else
        useradd -m -s /bin/bash $USERNAME
        usermod -aG sudo $USERNAME
        
        # Configurar SSH para o usu√°rio
        mkdir -p /home/$USERNAME/.ssh
        chmod 700 /home/$USERNAME/.ssh
        chown $USERNAME:$USERNAME /home/$USERNAME/.ssh
        
        log "‚úì Usu√°rio $USERNAME criado"
    fi
}

# Clonar reposit√≥rio
clone_repository() {
    log "üì• Clonando reposit√≥rio $GIT_REPO..."
    
    # Verificar se diret√≥rio existe e n√£o est√° vazio
    if [[ -d "$PROJECT_DIR" ]] && [[ -n "$(ls -A $PROJECT_DIR 2>/dev/null)" ]]; then
        warning "‚ö†Ô∏è Diret√≥rio $PROJECT_DIR j√° existe e n√£o est√° vazio"
        
        # Verificar se √© um reposit√≥rio git
        if [[ -d "$PROJECT_DIR/.git" ]]; then
            log "üì• Reposit√≥rio Git detectado, atualizando..."
            cd $PROJECT_DIR
            
            # Salvar mudan√ßas locais se houver
            if [[ -n "$(git status --porcelain)" ]]; then
                warning "‚ö†Ô∏è Existem mudan√ßas locais, fazendo stash..."
                git stash
            fi
            
            # Atualizar c√≥digo
            git pull origin main || git pull origin master
            log "‚úì Reposit√≥rio atualizado"
        else
            # N√£o √© um reposit√≥rio git, fazer backup e clonar
            warning "‚ö†Ô∏è N√£o √© um reposit√≥rio Git, fazendo backup..."
            BACKUP_DIR="${PROJECT_DIR}_backup_$(date +%Y%m%d_%H%M%S)"
            mv $PROJECT_DIR $BACKUP_DIR
            log "‚úì Backup salvo em: $BACKUP_DIR"
            
            # Criar diret√≥rio e clonar
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR
            git clone $GIT_REPO .
            log "‚úì Reposit√≥rio clonado em $PROJECT_DIR"
        fi
    else
        # Diret√≥rio n√£o existe ou est√° vazio
        mkdir -p $PROJECT_DIR
        cd $PROJECT_DIR
        git clone $GIT_REPO .
        log "‚úì Reposit√≥rio clonado em $PROJECT_DIR"
    fi
    
    # Configurar permiss√µes
    chown -R $USERNAME:$USERNAME $PROJECT_DIR
}

# Instalar depend√™ncias e build
build_application() {
    log "üî® Instalando depend√™ncias e fazendo build..."
    
    cd $PROJECT_DIR
    
    # Instalar depend√™ncias do servidor
    log "üì¶ Instalando depend√™ncias do servidor..."
    npm ci --production
    
    # Instalar depend√™ncias do cliente
    if [[ -d "client" ]]; then
        log "üì¶ Instalando depend√™ncias do cliente..."
        cd client
        npm ci
        cd ..
    fi
    
    # Build de produ√ß√£o
    log "üèóÔ∏è  Fazendo build de produ√ß√£o..."
    
    # Configurar vari√°veis de ambiente para build
    export NODE_ENV=production
    export NODE_OPTIONS="--max-old-space-size=4096"
    
    # Build do cliente
    if [[ -d "client" ]]; then
        cd client
        npm run build
        cd ..
    fi
    
    log "‚úì Build conclu√≠do com sucesso"

    # Garantir diret√≥rio de uploads e copiar arquivos do reposit√≥rio (sem sobrescrever existentes)
    log "üìÅ Verificando diret√≥rio de uploads..."
    mkdir -p "$PROJECT_DIR/uploads"
    mkdir -p "/home/$USERNAME/uploads" 
    if [[ -d "$PROJECT_DIR/uploads" ]]; then
        log "‚¨ÜÔ∏è  Sincronizando uploads do reposit√≥rio para /home/$USERNAME/uploads..."
        rsync -a --ignore-existing "$PROJECT_DIR/uploads/" "/home/$USERNAME/uploads/" || true
        chown -R $USERNAME:$USERNAME "/home/$USERNAME/uploads"
        # Garantir permiss√µes para Nginx ler
        find "/home/$USERNAME/uploads" -type d -exec chmod 755 {} + 2>/dev/null || true
        find "/home/$USERNAME/uploads" -type f -exec chmod 644 {} + 2>/dev/null || true
        # Recarregar Nginx para refletir alias
        systemctl reload nginx 2>/dev/null || true
    fi
}

# Configurar vari√°veis de ambiente
setup_environment() {
    log "‚öôÔ∏è  Configurando vari√°veis de ambiente..."
    
    cd $PROJECT_DIR
    
    # Gerar secrets seguros
    log "üîê Gerando secrets de seguran√ßa..."
    JWT_SECRET=$(openssl rand -base64 48 | tr -d '\n')
    SESSION_SECRET=$(openssl rand -base64 32 | tr -d '\n')
    
    log "‚úì JWT Secret gerado: ${JWT_SECRET:0:10}... (48 bytes)"
    log "‚úì Session Secret gerado: ${SESSION_SECRET:0:10}... (32 bytes)"
    
    # Criar arquivo .env se n√£o existir
    if [[ ! -f ".env" ]]; then
        log "üìù Criando arquivo .env..."
        
        cp .env.example .env 2>/dev/null || cat > .env << EOF
# =============================================================================
# CONFIGURA√á√ïES DE PRODU√á√ÉO - NOVUSIO
# =============================================================================
# Arquivo gerado automaticamente em: $(date)
# =============================================================================

# =============================================================================
# CONFIGURA√á√ïES GERAIS
# =============================================================================
NODE_ENV=production
PORT=$APP_PORT
HOST=0.0.0.0

# =============================================================================
# CONFIGURA√á√ïES DO BANCO DE DADOS
# =============================================================================
DB_PATH=$PROJECT_DIR/database.sqlite

# =============================================================================
# CONFIGURA√á√ïES DE UPLOAD
# =============================================================================
UPLOAD_PATH=$PROJECT_DIR/uploads
MAX_FILE_SIZE=10485760
ALLOWED_FILE_TYPES=jpg,jpeg,png,gif,pdf,doc,docx

# =============================================================================
# CONFIGURA√á√ïES DE AUTENTICA√á√ÉO
# =============================================================================
# JWT Secret - Gerado automaticamente (N√ÉO compartilhe!)
JWT_SECRET=$JWT_SECRET
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d

# Bcrypt salt rounds
BCRYPT_ROUNDS=12

# Session Secret - Gerado automaticamente
SESSION_SECRET=$SESSION_SECRET
SESSION_COOKIE_SECURE=true
SESSION_COOKIE_HTTP_ONLY=true
SESSION_COOKIE_SAME_SITE=strict

# =============================================================================
# CONFIGURA√á√ïES DE EMAIL (Configure para envio de emails)
# =============================================================================
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=
EMAIL_PASS=

# Emails de contato
CONTACT_EMAIL=$EMAIL
ADMIN_EMAIL=$EMAIL

# =============================================================================
# CONFIGURA√á√ïES DE DOM√çNIO E URL
# =============================================================================
DOMAIN=$DOMAIN
BASE_URL=https://$DOMAIN
API_URL=https://$DOMAIN/api
ADMIN_URL=https://$DOMAIN/admin

# =============================================================================
# CONFIGURA√á√ïES DE SEGURAN√áA
# =============================================================================
# CORS
CORS_ORIGIN=https://$DOMAIN
CORS_CREDENTIALS=true

# Rate limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# =============================================================================
# CONFIGURA√á√ïES DE LOG
# =============================================================================
LOG_LEVEL=info
LOG_FILE=/var/log/novusio/app.log
LOG_MAX_SIZE=10m
LOG_MAX_FILES=5

# =============================================================================
# CONFIGURA√á√ïES DE CACHE
# =============================================================================
CACHE_TTL=3600

# =============================================================================
# CONFIGURA√á√ïES DE BACKUP
# =============================================================================
BACKUP_ENABLED=true
BACKUP_SCHEDULE=0 2 * * *
BACKUP_RETENTION_DAYS=30
BACKUP_PATH=/opt/backups/novusio

# =============================================================================
# CONFIGURA√á√ïES ESPEC√çFICAS DA APLICA√á√ÉO
# =============================================================================
# Tamanho m√°ximo do body da requisi√ß√£o
MAX_BODY_SIZE=10mb

# Timeout das requisi√ß√µes
REQUEST_TIMEOUT=30000

# N√∫mero m√°ximo de conex√µes simult√¢neas
MAX_CONNECTIONS=1000

# Configura√ß√µes de upload espec√≠ficas
ALLOWED_IMAGE_TYPES=jpg,jpeg,png,gif,webp
ALLOWED_DOCUMENT_TYPES=pdf,doc,docx,txt
MAX_IMAGE_SIZE=5242880
MAX_DOCUMENT_SIZE=10485760

# =============================================================================
# CONFIGURA√á√ïES DE PERFORMANCE
# =============================================================================
# Cluster mode
CLUSTER_MODE=true
CLUSTER_WORKERS=auto

# Memory settings
NODE_OPTIONS=--max-old-space-size=2048

# =============================================================================
# CONFIGURA√á√ïES DE MANUTEN√á√ÉO
# =============================================================================
# Modo de manuten√ß√£o
MAINTENANCE_MODE=false
MAINTENANCE_MESSAGE=Site em manuten√ß√£o. Voltaremos em breve!

# =============================================================================
# CONFIGURA√á√ïES DE SSL/TLS
# =============================================================================
SSL_ENABLED=true
SSL_REDIRECT=true
HSTS_ENABLED=true
HSTS_MAX_AGE=31536000

# =============================================================================
# FIM DAS CONFIGURA√á√ïES
# =============================================================================
EOF
        
        log "‚úì Arquivo .env criado com sucesso"
    else
        warning "‚ö†Ô∏è Arquivo .env j√° existe, n√£o ser√° sobrescrito"
        log "üí° Para regenerar secrets, delete o arquivo .env e execute novamente"
    fi
    
    # Configurar permiss√µes
    chown $USERNAME:$USERNAME .env
    chmod 600 .env
    
    log "‚úì Vari√°veis de ambiente configuradas com seguran√ßa"
    
    # Salvar secrets em arquivo seguro para refer√™ncia
    SECRETS_FILE="$PROJECT_DIR/.secrets-backup-$(date +%Y%m%d_%H%M%S).txt"
    cat > "$SECRETS_FILE" << EOF
# BACKUP DE SECRETS - NOVUSIO
# Gerado em: $(date)
# IMPORTANTE: Guarde este arquivo em local seguro e delete do servidor!

JWT_SECRET=$JWT_SECRET
SESSION_SECRET=$SESSION_SECRET

# Para usar estes secrets novamente, adicione-os ao arquivo .env
EOF
    
    chown $USERNAME:$USERNAME "$SECRETS_FILE"
    chmod 400 "$SECRETS_FILE"
    
    info "üìã Backup dos secrets salvo em: $SECRETS_FILE"
    info "‚ö†Ô∏è  IMPORTANTE: Salve este arquivo em local seguro e delete do servidor!"
}

# Configurar PM2
setup_pm2() {
    log "üîÑ Configurando PM2..."
    
    cd $PROJECT_DIR
    
    # Criar arquivo de configura√ß√£o PM2
    cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'novusio-server',
    script: 'server/server.js',
    cwd: '$PROJECT_DIR',
    instances: 'max',
    exec_mode: 'cluster',
    autorestart: true,
    watch: false,
    env: {
      NODE_ENV: 'production',
      PORT: $APP_PORT
    },
    error_file: '/var/log/novusio/error.log',
    out_file: '/var/log/novusio/out.log',
    log_file: '/var/log/novusio/combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=2048',
    restart_delay: 4000,
    max_restarts: 10,
    min_uptime: '10s',
    kill_timeout: 5000,
    listen_timeout: 3000
  }]
};
EOF
    
    # Criar diret√≥rio de logs
    mkdir -p /var/log/novusio
    chown $USERNAME:$USERNAME /var/log/novusio
    
    # Iniciar aplica√ß√£o com PM2
    log "üöÄ Iniciando aplica√ß√£o com PM2..."
    sudo -u $USERNAME pm2 start ecosystem.config.js
    sudo -u $USERNAME pm2 save
    
    # Configurar PM2 para iniciar no boot
    log "‚öôÔ∏è Configurando PM2 para iniciar automaticamente no boot..."
    
    # Obter o comando de startup
    STARTUP_CMD=$(sudo -u $USERNAME pm2 startup systemd -u $USERNAME --hp /home/$USERNAME | grep "sudo env" | tail -1)
    
    if [[ -n "$STARTUP_CMD" ]]; then
        log "üìù Executando comando de startup do PM2..."
        eval $STARTUP_CMD
        log "‚úì PM2 startup configurado"
    else
        # Executar diretamente
        env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u $USERNAME --hp /home/$USERNAME
    fi
    
    echo ""
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${GREEN}‚úÖ PM2 CONFIGURADO COM SUCESSO!${NC}"
    echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo "  ‚úì Aplica√ß√£o iniciada em modo cluster"
    echo "  ‚úì Logs configurados em /var/log/novusio/"
    echo "  ‚úì Auto-restart habilitado"
    echo "  ‚úì Startup no boot configurado"
    echo ""
    
    # Verificar status
    sudo -u $USERNAME pm2 list
    
    echo ""
    sleep 2
}

# Configurar Nginx
setup_nginx() {
    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BLUE}üåê CONFIGURA√á√ÉO NGINX${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo "Configura√ß√µes que ser√£o aplicadas:"
    echo "  ‚Ä¢ Dom√≠nio: $DOMAIN"
    echo "  ‚Ä¢ Porta da aplica√ß√£o: $APP_PORT"
    echo "  ‚Ä¢ Proxy reverso: localhost:$APP_PORT"
    echo "  ‚Ä¢ Rate limiting: Sim"
    echo "  ‚Ä¢ Compress√£o Gzip: Sim"
    echo "  ‚Ä¢ Headers de seguran√ßa: Sim"
    echo ""
    
    # N√ÉO remover configura√ß√£o padr√£o se houver outros sites
    if [[ $(ls -A /etc/nginx/sites-enabled/ 2>/dev/null | wc -l) -gt 1 ]]; then
        warning "‚ö†Ô∏è Existem outros sites configurados. Mantendo configura√ß√£o padr√£o."
    else
        # Remover configura√ß√£o padr√£o apenas se for o √∫nico site
        log "üóëÔ∏è Removendo configura√ß√£o padr√£o do Nginx..."
        rm -f /etc/nginx/sites-enabled/default
    fi
    
    # Criar configura√ß√£o do site com nome espec√≠fico do dom√≠nio
    # IMPORTANTE: Configura√ß√£o inicial SEM SSL (ser√° adicionado pelo Certbot)
    log "üìù Criando configura√ß√£o inicial para $DOMAIN (sem SSL)..."
    cat > /etc/nginx/sites-available/$DOMAIN << 'NGINX_CONFIG_EOF'
# Rate limiting
limit_req_zone $binary_remote_addr zone=api_3000:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login_3000:10m rate=1r/s;

# Upstream para a aplica√ß√£o
upstream novusio_backend_3000 {
    server 127.0.0.1:3000;
    keepalive 32;
}

# Configura√ß√£o HTTP (Certbot ir√° adicionar HTTPS depois)
server {
    listen 80;
    listen [::]:80;
    server_name DOMAIN_PLACEHOLDER www.DOMAIN_PLACEHOLDER;
    
    # Root do React
    root PROJECT_DIR_PLACEHOLDER/client/dist;
    index index.html;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    
    # Certbot challenge
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }
    
    # Arquivos est√°ticos do React
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Cache de assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # API routes com rate limiting
    location /api/ {
        limit_req zone=api_3000 burst=20 nodelay;
        
        proxy_pass http://novusio_backend_3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
    
    # Admin login com rate limiting rigoroso
    location /api/auth/login {
        limit_req zone=login_3000 burst=5 nodelay;
        
        proxy_pass http://novusio_backend_3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Upload files
    location /uploads/ {
        alias PROJECT_DIR_PLACEHOLDER/uploads/;
        expires 1y;
        add_header Cache-Control "public";
        
        # Security - bloquear scripts
        location ~ \.(php|jsp|asp|sh|cgi)$ {
            deny all;
        }
    }
    
    # Deny access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ \.(env|config|sql|log)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}
NGINX_CONFIG_EOF
    
    # Substituir placeholders
    sed -i "s|DOMAIN_PLACEHOLDER|$DOMAIN|g" /etc/nginx/sites-available/$DOMAIN
    sed -i "s|PROJECT_DIR_PLACEHOLDER|$PROJECT_DIR|g" /etc/nginx/sites-available/$DOMAIN
    
    # Habilitar site com nome espec√≠fico
    log "üîó Habilitando site $DOMAIN..."
    ln -sf /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/
    
    # Testar configura√ß√£o
    log "üß™ Testando configura√ß√£o do Nginx..."
    if nginx -t 2>&1 | tee /tmp/nginx-test.log; then
        log "‚úì Configura√ß√£o do Nginx v√°lida!"
        
        # Recarregar Nginx
        log "üîÑ Recarregando Nginx..."
        systemctl reload nginx
        
        echo ""
        echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${GREEN}‚úÖ NGINX CONFIGURADO COM SUCESSO!${NC}"
        echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        echo "‚úì Configura√ß√£o criada: /etc/nginx/sites-available/$DOMAIN"
        echo "‚úì Site habilitado em: /etc/nginx/sites-enabled/$DOMAIN"
        echo "‚úì Proxy reverso: http://localhost:$APP_PORT"
        echo "‚úì Site tempor√°rio: http://$DOMAIN (HTTP)"
        echo ""
        echo -e "${BLUE}‚ÑπÔ∏è  Nota: SSL/HTTPS ser√° configurado no pr√≥ximo passo!${NC}"
        echo ""
        
    else
        error "‚ùå Erro na configura√ß√£o do Nginx!"
        cat /tmp/nginx-test.log
        warning "Revertendo altera√ß√µes..."
        rm -f /etc/nginx/sites-available/$DOMAIN
        rm -f /etc/nginx/sites-enabled/$DOMAIN
        exit 1
    fi
}

# Configurar SSL com Certbot
setup_ssl() {
    log "üîí Configurando SSL com Let's Encrypt..."
    
    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BLUE}üîê CONFIGURA√á√ÉO SSL/HTTPS${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo "Vamos configurar SSL gratuito com Let's Encrypt para:"
    echo "  ‚Ä¢ Dom√≠nio: $DOMAIN"
    echo "  ‚Ä¢ www.$DOMAIN"
    echo "  ‚Ä¢ Email: $EMAIL"
    echo ""
    echo "O que ser√° feito:"
    echo "  ‚úì Instalar Certbot"
    echo "  ‚úì Emitir certificado SSL gratuito"
    echo "  ‚úì Configurar redirect autom√°tico HTTP ‚Üí HTTPS"
    echo "  ‚úì Configurar renova√ß√£o autom√°tica (cron)"
    echo ""
    read -p "Deseja configurar SSL agora? (Y/n): " SETUP_SSL
    
    if [[ "$SETUP_SSL" =~ ^[Nn]$ ]]; then
        warning "‚ö†Ô∏è SSL n√£o configurado. Voc√™ pode configurar depois executando:"
        warning "   sudo certbot --nginx -d $DOMAIN -d www.$DOMAIN --email $EMAIL --redirect"
        return
    fi
    
    # Criar diret√≥rio para challenge do Certbot
    log "üìÅ Criando diret√≥rio para valida√ß√£o SSL..."
    mkdir -p /var/www/html
    
    # Instalar Certbot
    log "üì¶ Instalando Certbot..."
    apt-get install -y certbot python3-certbot-nginx
    
    # Garantir que Nginx est√° rodando
    log "üîÑ Garantindo que Nginx est√° rodando..."
    if ! systemctl is-active --quiet nginx; then
        log "üöÄ Iniciando Nginx..."
        systemctl start nginx
    else
        systemctl reload nginx || systemctl restart nginx
    fi
    
    # Verificar se porta 80 est√° acess√≠vel
    log "üîç Verificando porta 80..."
    if ! netstat -tuln 2>/dev/null | grep -q ":80 " && ! ss -tuln 2>/dev/null | grep -q ":80 "; then
        warning "‚ö†Ô∏è Porta 80 n√£o est√° acess√≠vel. SSL pode falhar."
    fi
    
    # Obter certificado SSL
    log "üîê Obtendo certificado SSL para $DOMAIN e www.$DOMAIN..."
    log "üìß Email para notifica√ß√µes: $EMAIL"
    echo ""
    echo -e "${YELLOW}‚è≥ Aguarde... Isso pode levar alguns minutos...${NC}"
    echo ""
    
    if certbot --nginx \
        -d $DOMAIN \
        -d www.$DOMAIN \
        --non-interactive \
        --agree-tos \
        --email $EMAIL \
        --redirect; then
        
        log "‚úì Certificado SSL obtido com sucesso!"
        
        # Configurar renova√ß√£o autom√°tica
        log "‚è∞ Configurando renova√ß√£o autom√°tica..."
        (crontab -l 2>/dev/null | grep -v certbot; echo "0 12 * * * /usr/bin/certbot renew --quiet && systemctl reload nginx") | crontab -
        
        log "‚úì Renova√ß√£o autom√°tica configurada (diariamente ao meio-dia)"
        
        # Testar renova√ß√£o
        log "üîç Testando renova√ß√£o..."
        certbot renew --dry-run
        
        echo ""
        echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${GREEN}‚úÖ SSL/HTTPS CONFIGURADO COM SUCESSO!${NC}"
        echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        echo "‚úì Seu site agora est√° dispon√≠vel em:"
        echo "  ‚Ä¢ https://$DOMAIN"
        echo "  ‚Ä¢ https://www.$DOMAIN"
        echo ""
        echo "‚úì Redirect autom√°tico HTTP ‚Üí HTTPS ativo"
        echo "‚úì Renova√ß√£o autom√°tica configurada"
        echo ""
        
    else
        error "‚ùå Falha ao obter certificado SSL"
        warning "Poss√≠veis causas:"
        warning "  ‚Ä¢ DNS n√£o est√° apontando para este servidor"
        warning "  ‚Ä¢ Porta 80 ou 443 bloqueada"
        warning "  ‚Ä¢ Dom√≠nio inv√°lido"
        echo ""
        warning "Voc√™ pode tentar manualmente depois:"
        warning "  sudo certbot --nginx -d $DOMAIN -d www.$DOMAIN --email $EMAIL --redirect"
    fi
}

# Configurar backup autom√°tico
setup_backup() {
    log "üíæ Configurando backup autom√°tico..."
    
    # Criar script de backup
    cat > /usr/local/bin/novusio-backup.sh << EOF
#!/bin/bash
# Script de backup autom√°tico do Novusio

BACKUP_DIR="/opt/backups/novusio"
DATE=\$(date +%Y%m%d_%H%M%S)
PROJECT_DIR="$PROJECT_DIR"

# Criar diret√≥rio de backup
mkdir -p \$BACKUP_DIR

# Backup do banco de dados
if [[ -f "\$PROJECT_DIR/database.sqlite" ]]; then
    cp "\$PROJECT_DIR/database.sqlite" "\$BACKUP_DIR/database_\$DATE.sqlite"
fi

# Backup dos uploads
if [[ -d "\$PROJECT_DIR/uploads" ]]; then
    tar -czf "\$BACKUP_DIR/uploads_\$DATE.tar.gz" -C "\$PROJECT_DIR" uploads/
fi

# Backup do c√≥digo (configura√ß√µes importantes)
tar -czf "\$BACKUP_DIR/config_\$DATE.tar.gz" -C "\$PROJECT_DIR" .env ecosystem.config.js

# Manter apenas os √∫ltimos 7 backups
find \$BACKUP_DIR -name "*.sqlite" -mtime +7 -delete
find \$BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "\$(date): Backup conclu√≠do" >> /var/log/novusio-backup.log
EOF
    
    chmod +x /usr/local/bin/novusio-backup.sh
    
    # Configurar cron para backup di√°rio √†s 2h da manh√£
    (crontab -l 2>/dev/null; echo "0 2 * * * /usr/local/bin/novusio-backup.sh") | crontab -
    
    log "‚úì Backup autom√°tico configurado"
}

# Configurar monitoramento
setup_monitoring() {
    log "üìä Configurando monitoramento..."
    
    # Script de monitoramento
    cat > /usr/local/bin/novusio-monitor.sh << EOF
#!/bin/bash
# Script de monitoramento do Novusio

LOG_FILE="/var/log/novusio-monitor.log"
PROJECT_DIR="$PROJECT_DIR"

# Fun√ß√£o de log
log_monitor() {
    echo "\$(date): \$1" >> \$LOG_FILE
}

# Verificar se PM2 est√° rodando
if ! pm2 list | grep -q "novusio-server"; then
    log_monitor "ERRO: Aplica√ß√£o n√£o est√° rodando, reiniciando..."
    cd \$PROJECT_DIR
    sudo -u $USERNAME pm2 restart ecosystem.config.js
fi

# Verificar uso de mem√≥ria
MEMORY_USAGE=\$(pm2 jlist | jq -r '.[] | select(.name=="novusio-server") | .monit.memory / 1024 / 1024')
if (( \$(echo "\$MEMORY_USAGE > 800" | bc -l) )); then
    log_monitor "AVISO: Uso de mem√≥ria alto: \${MEMORY_USAGE}MB"
fi

# Verificar espa√ßo em disco
DISK_USAGE=\$(df / | awk 'NR==2 {print \$5}' | sed 's/%//')
if [ \$DISK_USAGE -gt 85 ]; then
    log_monitor "ERRO: Espa√ßo em disco baixo: \${DISK_USAGE}%"
fi

log_monitor "Monitoramento executado com sucesso"
EOF
    
    chmod +x /usr/local/bin/novusio-monitor.sh
    
    # Configurar cron para monitoramento a cada 5 minutos
    (crontab -l 2>/dev/null; echo "*/5 * * * * /usr/local/bin/novusio-monitor.sh") | crontab -
    
    log "‚úì Monitoramento configurado"
}

# Configurar logrotate
setup_logrotate() {
    log "üìù Configurando rota√ß√£o de logs..."
    
    cat > /etc/logrotate.d/novusio << EOF
/var/log/novusio/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 $USERNAME $USERNAME
    postrotate
        sudo -u $USERNAME pm2 reloadLogs
    endscript
}
EOF
    
    log "‚úì Logrotate configurado"
}

# Inicializar banco de dados
init_database() {
    log "üóÑÔ∏è  Inicializando banco de dados..."
    
    cd $PROJECT_DIR
    
    # Executar inicializa√ß√£o do banco
    sudo -u $USERNAME npm run init-db
    
    log "‚úì Banco de dados inicializado"
}

# Reiniciar servi√ßos
restart_services() {
    log "üîÑ Reiniciando servi√ßos..."
    
    # Recarregar Nginx
    systemctl reload nginx
    
    # Reiniciar aplica√ß√£o
    cd $PROJECT_DIR
    sudo -u $USERNAME pm2 restart ecosystem.config.js
    
    # Habilitar servi√ßos
    systemctl enable nginx
    systemctl enable fail2ban
    
    log "‚úì Servi√ßos reiniciados"
}

# Verificar instala√ß√£o
verify_installation() {
    log "‚úÖ Verificando instala√ß√£o..."
    
    echo ""
    
    # Verificar se aplica√ß√£o est√° rodando
    if sudo -u $USERNAME pm2 list 2>/dev/null | grep -q "novusio-server.*online"; then
        log "‚úì Aplica√ß√£o rodando no PM2"
    else
        warning "‚ö†Ô∏è Verifica√ß√£o PM2 inconclusiva (aplica√ß√£o pode estar rodando)"
        # N√£o parar o script, apenas avisar
    fi
    
    # Verificar Nginx
    if systemctl is-active --quiet nginx; then
        log "‚úì Nginx ativo"
    else
        warning "‚ö†Ô∏è Nginx n√£o est√° ativo"
    fi
    
    # Verificar SSL (n√£o √© erro fatal se n√£o tiver)
    if [[ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]]; then
        log "‚úì Certificado SSL instalado"
    else
        warning "‚ö†Ô∏è Certificado SSL n√£o encontrado (pode ser configurado depois)"
    fi
    
    # Testar acesso HTTP primeiro
    log "üåê Testando acesso ao site..."
    
    # Testar HTTP
    if curl -s -o /dev/null -w "%{http_code}" http://$DOMAIN 2>/dev/null | grep -q "200\|301\|302"; then
        log "‚úì Site acess√≠vel via HTTP"
    fi
    
    # Testar HTTPS se SSL estiver configurado
    if [[ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]]; then
        if curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN 2>/dev/null | grep -q "200\|301\|302"; then
            log "‚úì Site acess√≠vel via HTTPS"
        else
            warning "‚ö†Ô∏è HTTPS pode n√£o estar acess√≠vel ainda (aguarde propaga√ß√£o DNS)"
        fi
    fi
}

# Mostrar informa√ß√µes finais
show_final_info() {
    echo -e "${GREEN}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                                                              ‚ïë"
    echo "‚ïë                    üéâ DEPLOY CONCLU√çDO! üéâ                  ‚ïë"
    echo "‚ïë                                                              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    
    echo -e "${CYAN}üìã INFORMA√á√ïES DO DEPLOY:${NC}"
    echo "=================================="
    echo -e "üåê Site: ${GREEN}https://$DOMAIN${NC}"
    echo -e "üë§ Usu√°rio: ${GREEN}$USERNAME${NC}"
    echo -e "üìÅ Diret√≥rio: ${GREEN}$PROJECT_DIR${NC}"
    echo -e "üîß Porta: ${GREEN}$APP_PORT${NC}"
    echo ""
    
    echo -e "${CYAN}üîß COMANDOS √öTEIS:${NC}"
    echo "=================================="
    echo -e "üìä Status PM2: ${YELLOW}sudo -u $USERNAME pm2 status${NC}"
    echo -e "üìù Logs PM2: ${YELLOW}sudo -u $USERNAME pm2 logs${NC}"
    echo -e "üîÑ Reiniciar: ${YELLOW}sudo -u $USERNAME pm2 restart novusio-server${NC}"
    echo -e "üìã Logs Nginx: ${YELLOW}tail -f /var/log/nginx/access.log${NC}"
    echo -e "üîí Renovar SSL: ${YELLOW}certbot renew${NC}"
    echo ""
    
    echo -e "${CYAN}üîê PR√ìXIMOS PASSOS:${NC}"
    echo "=================================="
    echo "1. Acesse https://$DOMAIN/admin"
    echo "2. Fa√ßa login com as credenciais padr√£o"
    echo "3. Configure suas informa√ß√µes da empresa"
    echo "4. Altere a senha padr√£o do admin"
    echo "5. Configure backup e monitoramento"
    echo ""
    
    echo -e "${YELLOW}‚ö†Ô∏è  IMPORTANTE:${NC}"
    echo "=================================="
    echo "‚Ä¢ Altere a senha padr√£o do admin imediatamente"
    echo "‚Ä¢ Configure backup regular dos dados"
    echo "‚Ä¢ Monitore os logs regularmente"
    echo "‚Ä¢ Mantenha o sistema atualizado"
    echo ""
}

# Fun√ß√£o principal com menu
main() {
    show_banner
    check_root
    
    # Loop do menu principal
    while true; do
        show_menu
        
        case $MENU_CHOICE in
            1)
                deploy_complete
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            2)
                update_application
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            3)
                remove_project
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            4)
                show_system_status
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            5)
                quick_maintenance
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            6)
                show_logs
                ;;
            7)
                diagnose_nginx
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            8)
                fix_upload_issues
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            9)
                echo -e "${GREEN}üëã At√© logo!${NC}"
                exit 0
                ;;
            10)
                quick_update
                echo ""
                read -p "Pressione Enter para voltar ao menu..."
                ;;
            *)
                echo -e "${RED}‚ùå Op√ß√£o inv√°lida. Escolha entre 1-10.${NC}"
                sleep 2
                ;;
        esac
    done
}

# Executar fun√ß√£o principal
main "$@"
