#!/bin/bash

# ‚öôÔ∏è Configurador de .env - Site Novusio
# Script interativo para configurar vari√°veis de ambiente em produ√ß√£o

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_title() {
    echo ""
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë                                                                                ‚ïë${NC}"
    echo -e "${CYAN}‚ïë                    ‚öôÔ∏è CONFIGURADOR DE .ENV - SITE NOVUSIO                       ‚ïë${NC}"
    echo -e "${CYAN}‚ïë                                                                                ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

# Fun√ß√£o para gerar string aleat√≥ria
generate_random_string() {
    local length=${1:-32}
    openssl rand -base64 $length | tr -d "=+/" | cut -c1-$length 2>/dev/null || \
    cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w $length | head -n 1
}

# Fun√ß√£o para validar email
validate_email() {
    local email=$1
    if [[ $email =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]; then
        return 0
    else
        return 1
    fi
}

# Fun√ß√£o para validar dom√≠nio
validate_domain() {
    local domain=$1
    if [[ $domain =~ ^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}$ ]]; then
        return 0
    else
        return 1
    fi
}

# Fun√ß√£o para criar arquivo .env
create_env_file() {
    local env_file="/opt/novusio/.env"
    
    print_status "Criando arquivo .env..."
    
    # Verificar se j√° existe
    if [[ -f "$env_file" ]]; then
        print_warning "Arquivo .env j√° existe"
        read -p "Sobrescrever arquivo existente? (y/N): " overwrite
        
        if [[ "$overwrite" != "y" && "$overwrite" != "Y" ]]; then
            print_status "Mantendo arquivo existente"
            return 0
        fi
    fi
    
    # Criar backup do arquivo existente
    if [[ -f "$env_file" ]]; then
        sudo cp "$env_file" "$env_file.backup.$(date +%Y%m%d-%H%M%S)"
        print_success "Backup do .env criado"
    fi
    
    # Criar novo arquivo .env
    sudo tee "$env_file" > /dev/null << EOF
# üîß Configura√ß√£o de Produ√ß√£o - Site Novusio
# Gerado automaticamente em $(date)

# Configura√ß√µes do servidor
NODE_ENV=production
PORT=3000

# Configura√ß√µes do dom√≠nio
DOMAIN=
EMAIL=

# Configura√ß√µes de autentica√ß√£o JWT
JWT_SECRET=
JWT_EXPIRES_IN=1h

# Configura√ß√µes do banco de dados
DB_PATH=/opt/novusio/app/database.sqlite

# Configura√ß√µes de upload
MAX_FILE_SIZE=52428800
UPLOAD_PATH=/opt/novusio/app/client/uploads

# Configura√ß√µes de seguran√ßa
BCRYPT_ROUNDS=12
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# Configura√ß√µes de logs
LOG_LEVEL=info
LOG_FILE=/var/log/novusio/app.log

# Configura√ß√µes de backup
BACKUP_ENABLED=true
BACKUP_SCHEDULE=0 2 * * *
BACKUP_RETENTION_DAYS=30

# Configura√ß√µes de monitoramento
HEALTH_CHECK_ENABLED=true
METRICS_ENABLED=true

# Configura√ß√µes de cache
CACHE_ENABLED=true
CACHE_TTL=3600

# Configura√ß√µes de CORS
CORS_ORIGIN=
CORS_CREDENTIALS=true

# Configura√ß√µes de sess√£o
SESSION_SECRET=
SESSION_MAX_AGE=86400000

# Configura√ß√µes de rate limiting
RATE_LIMIT_API=100
RATE_LIMIT_LOGIN=5
RATE_LIMIT_ADMIN=20

# Configura√ß√µes de SSL
SSL_ENABLED=true
SSL_REDIRECT=true

# Configura√ß√µes de backup autom√°tico
AUTO_BACKUP_ENABLED=true
AUTO_BACKUP_TIME=02:00
AUTO_BACKUP_RETENTION=7

# Configura√ß√µes de notifica√ß√µes
NOTIFICATIONS_ENABLED=true
NOTIFICATION_EMAIL=

# Configura√ß√µes de manuten√ß√£o
MAINTENANCE_MODE=false
MAINTENANCE_MESSAGE=Site em manuten√ß√£o. Volte em breve.

# Configura√ß√µes de debug (manter false em produ√ß√£o)
DEBUG=false
VERBOSE_LOGGING=false

# Configura√ß√µes de performance
CLUSTER_MODE=false
WORKER_PROCESSES=1
MAX_MEMORY=1073741824

# Configura√ß√µes de timeout
REQUEST_TIMEOUT=30000
CONNECTION_TIMEOUT=5000

# Configura√ß√µes de compress√£o
COMPRESSION_ENABLED=true
COMPRESSION_LEVEL=6

# Configura√ß√µes de seguran√ßa adicional
SECURITY_HEADERS=true
XSS_PROTECTION=true
CSRF_PROTECTION=true
EOF
    
    # Definir permiss√µes
    sudo chown novusio:novusio "$env_file"
    sudo chmod 600 "$env_file"
    
    print_success "Arquivo .env criado: $env_file"
}

# Fun√ß√£o para configurar vari√°veis b√°sicas
configure_basic_vars() {
    local env_file="/opt/novusio/.env"
    
    print_status "Configurando vari√°veis b√°sicas..."
    echo ""
    
    # DOMAIN
    while true; do
        read -p "Digite o dom√≠nio (ex: exemplo.com): " domain
        if [[ -n "$domain" ]]; then
            if validate_domain "$domain"; then
                sudo sed -i "s/DOMAIN=/DOMAIN=$domain/g" "$env_file"
                print_success "Dom√≠nio configurado: $domain"
                break
            else
                print_error "Formato de dom√≠nio inv√°lido"
            fi
        else
            print_warning "Dom√≠nio √© obrigat√≥rio"
        fi
    done
    
    # EMAIL
    while true; do
        read -p "Digite o email para notifica√ß√µes: " email
        if [[ -n "$email" ]]; then
            if validate_email "$email"; then
                sudo sed -i "s/EMAIL=/EMAIL=$email/g" "$env_file"
                sudo sed -i "s/NOTIFICATION_EMAIL=/NOTIFICATION_EMAIL=$email/g" "$env_file"
                print_success "Email configurado: $email"
                break
            else
                print_error "Formato de email inv√°lido"
            fi
        else
            print_warning "Email √© obrigat√≥rio"
        fi
    done
    
    # CORS_ORIGIN
    sudo sed -i "s/CORS_ORIGIN=/CORS_ORIGIN=https:\/\/$domain/g" "$env_file"
    print_success "CORS configurado para: https://$domain"
}

# Fun√ß√£o para gerar secrets
generate_secrets() {
    local env_file="/opt/novusio/.env"
    
    print_status "Gerando secrets seguros..."
    
    # JWT_SECRET
    local jwt_secret=$(generate_random_string 64)
    sudo sed -i "s/JWT_SECRET=/JWT_SECRET=$jwt_secret/g" "$env_file"
    print_success "JWT_SECRET gerado"
    
    # SESSION_SECRET
    local session_secret=$(generate_random_string 64)
    sudo sed -i "s/SESSION_SECRET=/SESSION_SECRET=$session_secret/g" "$env_file"
    print_success "SESSION_SECRET gerado"
    
    print_success "Secrets gerados com sucesso"
}

# Fun√ß√£o para configurar op√ß√µes avan√ßadas
configure_advanced() {
    local env_file="/opt/novusio/.env"
    
    print_status "Configurando op√ß√µes avan√ßadas..."
    echo ""
    
    # SMTP (opcional)
    read -p "Configurar SMTP para envio de emails? (y/N): " configure_smtp
    if [[ "$configure_smtp" == "y" || "$configure_smtp" == "Y" ]]; then
        read -p "Host SMTP (ex: smtp.gmail.com): " smtp_host
        read -p "Porta SMTP (ex: 587): " smtp_port
        read -p "Usu√°rio SMTP: " smtp_user
        read -s -p "Senha SMTP: " smtp_pass
        echo ""
        
        if [[ -n "$smtp_host" ]]; then
            echo "SMTP_HOST=$smtp_host" | sudo tee -a "$env_file" > /dev/null
            echo "SMTP_PORT=$smtp_port" | sudo tee -a "$env_file" > /dev/null
            echo "SMTP_USER=$smtp_user" | sudo tee -a "$env_file" > /dev/null
            echo "SMTP_PASS=$smtp_pass" | sudo tee -a "$env_file" > /dev/null
            print_success "SMTP configurado"
        fi
    fi
    
    # Redis (opcional)
    read -p "Configurar Redis para cache? (y/N): " configure_redis
    if [[ "$configure_redis" == "y" || "$configure_redis" == "Y" ]]; then
        read -p "Host Redis (ex: localhost): " redis_host
        read -p "Porta Redis (ex: 6379): " redis_port
        
        if [[ -n "$redis_host" ]]; then
            echo "REDIS_ENABLED=true" | sudo tee -a "$env_file" > /dev/null
            echo "REDIS_HOST=$redis_host" | sudo tee -a "$env_file" > /dev/null
            echo "REDIS_PORT=$redis_port" | sudo tee -a "$env_file" > /dev/null
            print_success "Redis configurado"
        fi
    fi
    
    # CDN (opcional)
    read -p "Configurar CDN? (y/N): " configure_cdn
    if [[ "$configure_cdn" == "y" || "$configure_cdn" == "Y" ]]; then
        read -p "URL do CDN (ex: https://cdn.exemplo.com): " cdn_url
        
        if [[ -n "$cdn_url" ]]; then
            echo "CDN_ENABLED=true" | sudo tee -a "$env_file" > /dev/null
            echo "CDN_URL=$cdn_url" | sudo tee -a "$env_file" > /dev/null
            print_success "CDN configurado"
        fi
    fi
}

# Fun√ß√£o para validar configura√ß√£o
validate_config() {
    local env_file="/opt/novusio/.env"
    
    print_status "Validando configura√ß√£o..."
    
    # Verificar vari√°veis obrigat√≥rias
    local required_vars=("DOMAIN" "EMAIL" "JWT_SECRET")
    local missing_vars=()
    
    for var in "${required_vars[@]}"; do
        if ! grep -q "^$var=" "$env_file" || grep -q "^$var=$" "$env_file"; then
            missing_vars+=("$var")
        fi
    done
    
    if [[ ${#missing_vars[@]} -gt 0 ]]; then
        print_error "Vari√°veis obrigat√≥rias faltando: ${missing_vars[*]}"
        return 1
    fi
    
    # Verificar formato do dom√≠nio
    local domain=$(grep "^DOMAIN=" "$env_file" | cut -d'=' -f2)
    if ! validate_domain "$domain"; then
        print_error "Formato de dom√≠nio inv√°lido: $domain"
        return 1
    fi
    
    # Verificar formato do email
    local email=$(grep "^EMAIL=" "$env_file" | cut -d'=' -f2)
    if ! validate_email "$email"; then
        print_error "Formato de email inv√°lido: $email"
        return 1
    fi
    
    # Verificar JWT_SECRET
    local jwt_secret=$(grep "^JWT_SECRET=" "$env_file" | cut -d'=' -f2)
    if [[ ${#jwt_secret} -lt 32 ]]; then
        print_error "JWT_SECRET muito curto (m√≠nimo 32 caracteres)"
        return 1
    fi
    
    print_success "Configura√ß√£o v√°lida!"
    return 0
}

# Fun√ß√£o para mostrar resumo
show_summary() {
    local env_file="/opt/novusio/.env"
    
    print_status "Resumo da configura√ß√£o:"
    echo ""
    
    echo "üåê Dom√≠nio: $(grep "^DOMAIN=" "$env_file" | cut -d'=' -f2)"
    echo "üìß Email: $(grep "^EMAIL=" "$env_file" | cut -d'=' -f2)"
    echo "üîí JWT Secret: $(grep "^JWT_SECRET=" "$env_file" | cut -d'=' -f2 | cut -c1-10)..."
    echo "üìÅ Arquivo: $env_file"
    echo ""
}

# Fun√ß√£o principal
main() {
    print_title
    
    # Verificar se est√° rodando como usu√°rio correto
    if [[ $EUID -eq 0 ]]; then
        print_error "Este script n√£o deve ser executado como root diretamente."
        print_status "Execute como usu√°rio normal e use sudo quando necess√°rio."
        exit 1
    fi
    
    # Verificar se o diret√≥rio da aplica√ß√£o existe
    if [[ ! -d "/opt/novusio" ]]; then
        print_error "Diret√≥rio da aplica√ß√£o n√£o encontrado: /opt/novusio"
        print_status "Execute primeiro a instala√ß√£o completa."
        exit 1
    fi
    
    print_status "Configurando vari√°veis de ambiente para produ√ß√£o..."
    echo ""
    
    # Criar arquivo .env
    create_env_file
    
    # Configurar vari√°veis b√°sicas
    configure_basic_vars
    
    # Gerar secrets
    generate_secrets
    
    # Configurar op√ß√µes avan√ßadas
    configure_advanced
    
    # Validar configura√ß√£o
    if validate_config; then
        print_success "‚úÖ Configura√ß√£o validada com sucesso!"
    else
        print_error "‚ùå Configura√ß√£o inv√°lida"
        exit 1
    fi
    
    # Mostrar resumo
    show_summary
    
    echo -e "${PURPLE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    print_success "üéâ Configura√ß√£o do .env conclu√≠da com sucesso!"
    echo ""
    print_status "Pr√≥ximos passos:"
    echo "1. Configurar SSL: sudo ./instalador/setup-ssl.sh"
    echo "2. Iniciar aplica√ß√£o: sudo systemctl start novusio"
    echo "3. Verificar status: sudo systemctl status novusio"
    echo ""
    print_status "Para editar manualmente: sudo nano /opt/novusio/.env"
    echo ""
    echo -e "${PURPLE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
}

# Executar fun√ß√£o principal
main
